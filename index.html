<!DOCTYPE html>
<html>
<head>
    <title>Advanced Tower Defense</title>
    <style>
        #gameContainer {
            display: flex;
        }
        
        #gameBoard {
            width: 1000px; /* Увеличено для расширенного пути */
            height: 700px; /* Увеличено для расширенного пути */
            border: 1px solid black;
            position: relative;
            background: #eee;
        }
        
        .tile {
            width: 40px;
            height: 40px;
            position: absolute;
        }
        
        .path {
            background: #666;
        }
        
        .start {
            background: gold;
        }
        
        .end {
            background: green;
        }
        
        .enemy {
            width: 20px;
            height: 20px;
            background: red;
            position: absolute;
            border-radius: 50%;
        }
        
        .tower {
            width: 30px;
            height: 30px;
            position: absolute;
            cursor: pointer;
            transform: translate(-15px, -15px); /* Центрирование башни */
        }
        
        .tower.pistol {
            background: blue;
            border-radius: 50%;
        }
        
        .tower.swordsman {
            background: brown;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }
        
        .tower.sniper {
            background: purple;
        }
        
        .radius {
            position: absolute;
            border: 1px dashed rgba(0,0,255,0.5);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%); /* Правильное позиционирование */
            box-sizing: border-box;
        }
        
        #shop {
            padding: 20px;
            background: #ccc;
            width: 250px;
        }
        
        #upgradeMenu {
            position: fixed;
            right: 250px;
            top: 20px;
            background: #fff;
            padding: 15px;
            border: 2px solid #FFB74D;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .shop-item {
            margin: 10px 0;
            padding: 12px;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(145deg, #81C784, #66BB6A);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .shop-item:hover {
            background: linear-gradient(145deg, #66BB6A, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        #upgradeMenu button {
            margin: 8px 0;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: linear-gradient(145deg, #FFA726, #FB8C00);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        #upgradeMenu button:hover {
            background: linear-gradient(145deg, #FB8C00, #F57C00);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        #gameOver {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            display: none;
            z-index: 2000;
        }
        
        #gameOver button {
            padding: 10px 20px;
            margin-top: 20px;
            font-size: 16px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
         .enemy.strong {
            background: purple;
            width: 25px;
            height: 25px;
        }
        
        .enemy.elite {
            background: gold;
            width: 30px;
            height: 30px;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
          .tower.mega {
            background: linear-gradient(45deg, #ff0000, #ffff00);
            clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
        }
        
        .enemy.green {
            background: #00ff00;
            width: 25px;
            height: 25px;
        }
        
        .enemy.boss {
            background: #ff0000;
            width: 40px;
            height: 40px;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: bossPulse 2s infinite;
        }
        
        .enemy.black {
            background: #000000;
            width: 20px;
            height: 20px;
        }
        
        .boss-health {
            position: absolute;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            transform: translate(-50%, -30px);
            white-space: nowrap;
        }
        
        .speed-control {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
        
        .speed-control button {
            padding: 8px 15px;
            margin: 0 5px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .speed-control button.active {
            background: #2E7D32;
            font-weight: bold;
        }
        
        @keyframes bossPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="gameBoard"></div>
        <div id="shop">
            <div class="shop-item" onclick="selectTower('pistol', 50)">
                Пистолет (50)<br>
                Урон: 1/сек<br>
                Радиус: 10st
            </div>
            <div class="shop-item" onclick="selectTower('swordsman', 80)">
                Мечник (80)<br>
                Урон: 2/0.5сек<br>
                Радиус: 5st
            </div>
            <div class="shop-item" onclick="selectTower('sniper', 250)">
                Снайпер (250)<br>
                Урон: 10/5сек<br>
                Радиус: 100st
            </div>
            <div id="upgradeMenu">
                <h4>Улучшение башни</h4>
                <div id="towerStats"></div>
                <button onclick="upgradeTower()">Улучшить</button>
                <button onclick="closeUpgradeMenu()">Закрыть</button>
            </div>
            <div style="margin-top: 20px; font-weight: bold;">
                Деньги: <span id="money">100</span>
            </div>
            <div style="font-weight: bold;">
                Волна: <span id="wave">1</span>
            </div>
        </div>
    </div>
    
    <div id="gameOver">
        <h2>Враги добрались до цели!</h2>
        <p>Игра окончена</p>
        <button onclick="restartGame()">Играть снова</button>
    </div>
     <div class="speed-control">
        <button id="speed1x" class="active" onclick="setGameSpeed(1)">1X</button>
        <button id="speed2x" onclick="setGameSpeed(2)">2X</button>
    </div>
    
    <div id="gameContainer">
        <!-- ... (остальная разметка магазина) ... -->
            <div class="shop-item" onclick="selectTower('mega', 1500)">
                МЕГА (1500)<br>
                Двойной режим:<br>
                Ближний: 2/0.5сек 5st<br>
                Дальний: 1/сек 20st
            </div>

    <script>
        const board = document.getElementById('gameBoard');
        const tileSize = 40;
        let placingTower = false;
        let money = 100;
        let currentWave = 1;
        let enemies = [];
        let towers = [];
        let selectedTower = null;
        let waveInProgress = false;
        let gameActive = true;

        const towerTypes = {
            pistol: {
                type: 'pistol',
                cost: 50,
                damage: 1,
                radius: 100,
                attackSpeed: 1,
                upgraded: false,
                upgradeCost: 150,
                upgradedDamage: 2,
                upgradedRadius: 150
            },
            swordsman: {
                type: 'swordsman',
                cost: 80,
                damage: 2,
                radius: 50,
                attackSpeed: 2,
                upgraded: false,
                upgradeCost: 150,
                upgradedDamage: 3,
                upgradedAttackSpeed: 3
            },
            sniper: {
                type: 'sniper',
                cost: 250,
                damage: 10,
                radius: 1000,
                attackSpeed: 0.2,
                upgraded: false,
                upgradeCost: 1000,
                upgradedAttackSpeed: 0.4
            }
        };

        function createBoard() {
            // Расширенный путь с изгибами
            const path = [
                {x:0, y:4}, {x:1, y:4}, {x:2, y:4}, {x:3, y:4}, {x:4, y:4}, {x:5, y:4},
                {x:5, y:5}, {x:5, y:6}, {x:5, y:7}, {x:5, y:8}, {x:5, y:9},
                {x:6, y:9}, {x:7, y:9}, {x:8, y:9}, {x:9, y:9}, {x:10, y:9},
                {x:10, y:8}, {x:10, y:7}, {x:10, y:6}, {x:10, y:5},
                {x:11, y:5}, {x:12, y:5}, {x:13, y:5}, {x:14, y:5}, {x:15, y:5},
                {x:15, y:6}, {x:15, y:7}, {x:15, y:8}, {x:15, y:9}, {x:15, y:10},
                {x:16, y:10}, {x:17, y:10}, {x:18, y:10}, {x:19, y:10}, {x:20, y:10},
                {x:20, y:11}
            ];
            
            // Создаем дорожку
            path.forEach((pos, index) => {
                const tile = document.createElement('div');
                tile.className = `tile ${index === 0 ? 'start' : index === path.length-1 ? 'end' : 'path'}`;
                tile.style.left = pos.x * tileSize + 'px';
                tile.style.top = pos.y * tileSize + 'px';
                board.appendChild(tile);
            });
            
            // Запоминаем позицию конечной точки
            endPosition = {
                x: path[path.length-1].x * tileSize,
                y: path[path.length-1].y * tileSize
            };
        }

        function selectTower(type, cost) {
            if(!gameActive) return;
            if(money >= cost && !placingTower) {
                placingTower = type;
                money -= cost;
                updateMoney();
            }
        }

        board.addEventListener('click', (e) => {
            if(!gameActive) return;
            if(placingTower) {
                const rect = board.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Проверка на дорожку
                const isPath = [...document.querySelectorAll('.tile')].some(tile => {
                    const tileX = parseInt(tile.style.left);
                    const tileY = parseInt(tile.style.top);
                    return x >= tileX && x <= tileX + tileSize && 
                           y >= tileY && y <= tileY + tileSize;
                });
                
                // Проверка на другие башни
                const isTower = towers.some(tower => {
                    return Math.sqrt(Math.pow(x - tower.x, 2) + Math.pow(y - tower.y, 2)) < 30;
                });
                
                if(!isPath && !isTower) {
                    const tower = {
                        ...towerTypes[placingTower],
                        x: x,
                        y: y,
                        totalDamage: 0,
                        lastAttack: 0
                    };
                    towers.push(tower);
                    placeTower(tower);
                    placingTower = false;
                }
            }
        });

        function placeTower(tower) {
            const elem = document.createElement('div');
            elem.className = `tower ${tower.type}`;
            elem.style.left = tower.x + 'px';
            elem.style.top = tower.y + 'px';
            elem.onclick = () => showUpgradeMenu(tower);
            
            const radius = document.createElement('div');
            radius.className = 'radius';
            radius.style.width = tower.radius*2 + 'px';
            radius.style.height = tower.radius*2 + 'px';
            radius.style.left = tower.x + 'px';
            radius.style.top = tower.y + 'px';
            
            board.appendChild(elem);
            board.appendChild(radius);
            tower.elem = elem;
            tower.radiusElem = radius;
        }

        function spawnEnemy(hp) {
            const enemy = {
                x: 0,
                y: 4 * tileSize + 10,
                hp: hp,
                pathIndex: 0
            };
            enemies.push(enemy);
            
            const elem = document.createElement('div');
            elem.className = 'enemy';
            elem.style.left = enemy.x + 'px';
            elem.style.top = enemy.y + 'px';
            board.appendChild(elem);
            enemy.elem = elem;
        }

        function gameLoop() {
            if(!gameActive) return;
            
            // Проверяем, достиг ли кто-то конца
            enemies.forEach((enemy, index) => {
                const path = document.querySelectorAll('.tile');
                if(enemy.pathIndex >= path.length - 1) {
                    // Враг достиг конца
                    enemy.elem.remove();
                    enemies.splice(index, 1);
                    endGame();
                    return;
                }
                
                const target = path[enemy.pathIndex + 1];
                if(target) {
                    const targetX = parseInt(target.style.left) + tileSize/2;
                    const targetY = parseInt(target.style.top) + tileSize/2;
                    
                    const dx = targetX - enemy.x;
                    const dy = targetY - enemy.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    if(distance < 2) {
                        enemy.pathIndex++;
                    } else {
                        const speed = 2;
                        enemy.x += (dx / distance) * speed;
                        enemy.y += (dy / distance) * speed;
                    }
                    
                    enemy.elem.style.left = enemy.x + 'px';
                    enemy.elem.style.top = enemy.y + 'px';
                }
            });
            
            attackLogic();
            requestAnimationFrame(gameLoop);
        }

        function attackLogic() {
            towers.forEach(tower => {
                // Находим ближайшего врага в радиусе
                let closestEnemy = null;
                let minDistance = Infinity;
                
                enemies.forEach(enemy => {
                    const dx = enemy.x - tower.x;
                    const dy = enemy.y - tower.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    if(distance < tower.radius && distance < minDistance) {
                        closestEnemy = enemy;
                        minDistance = distance;
                    }
                });
                
                // Атакуем ближайшего врага
                if(closestEnemy && Date.now() - tower.lastAttack > 1000/tower.attackSpeed) {
                    closestEnemy.hp -= tower.damage;
                    tower.totalDamage += tower.damage;
                    tower.lastAttack = Date.now();
                    
                    if(closestEnemy.hp <= 0) {
                        closestEnemy.elem.remove();
                        enemies.splice(enemies.indexOf(closestEnemy), 1);
                        money += 10;
                        updateMoney();
                    }
                }
            });
            
            checkWaveCompletion();
        }

        function checkWaveCompletion() {
            if(enemies.length === 0 && waveInProgress) {
                waveInProgress = false;
                currentWave++;
                startWave();
            }
        }

        function startWave() {
            if(!gameActive) return;
            
            waveInProgress = true;
            document.getElementById('wave').textContent = currentWave;
            
            if(currentWave === 1) {
                for(let i = 0; i < 3; i++) {
                    setTimeout(() => spawnEnemy(2), i*2000);
                }
            } else if(currentWave === 2) {
                for(let i = 0; i < 5; i++) {
                    setTimeout(() => spawnEnemy(2), i*2000);
                }
            } else if(currentWave === 3) {
                for(let i = 0; i < 10; i++) {
                    setTimeout(() => spawnEnemy(2), i*1500);
                }
            } else if(currentWave === 4) {
                for(let i = 0; i < 15; i++) {
                    setTimeout(() => spawnEnemy(2), i*1000);
                }
            } else if(currentWave === 5) {
                for(let i = 0; i < 5; i++) {
                    setTimeout(() => spawnEnemy(2), i*1500);
                }
                setTimeout(() => spawnEnemy(5), 5*1500);
            }
        }

        function showUpgradeMenu(tower) {
            if(!gameActive) return;
            
            closeUpgradeMenu();
            selectedTower = tower;
            const menu = document.getElementById('upgradeMenu');
            menu.style.display = 'block';
            
            let upgradeButton = menu.querySelector('button');
            upgradeButton.textContent = `Улучшить (${tower.upgradeCost})`;
            
            document.getElementById('towerStats').innerHTML = `
                <strong>${getTowerName(tower.type)}</strong><br>
                Урон: ${tower.damage}<br>
                Радиус: ${Math.round(tower.radius/10)}st<br>
                Скорость: ${(1/tower.attackSpeed).toFixed(1)} атак/сек<br>
                ${tower.upgraded ? '<span style="color:green">УЛУЧШЕНО</span>' : ''}
            `;
        }

        function getTowerName(type) {
            switch(type) {
                case 'pistol': return 'Пистолет';
                case 'swordsman': return 'Мечник';
                case 'sniper': return 'Снайпер';
                default: return 'Башня';
            }
        }

        function closeUpgradeMenu() {
            document.getElementById('upgradeMenu').style.display = 'none';
            selectedTower = null;
        }

        function upgradeTower() {
            if(!selectedTower || !gameActive) return;
            if(selectedTower.upgraded || money < selectedTower.upgradeCost) return;
            
            money -= selectedTower.upgradeCost;
            updateMoney();
            selectedTower.upgraded = true;
            
            switch(selectedTower.type) {
                case 'pistol':
                    selectedTower.damage = selectedTower.upgradedDamage;
                    selectedTower.radius = selectedTower.upgradedRadius;
                    break;
                case 'swordsman':
                    selectedTower.damage = selectedTower.upgradedDamage;
                    selectedTower.attackSpeed = selectedTower.upgradedAttackSpeed;
                    break;
                case 'sniper':
                    selectedTower.attackSpeed = selectedTower.upgradedAttackSpeed;
                    break;
            }
            
            updateTowerVisuals(selectedTower);
            showUpgradeMenu(selectedTower);
        }

        function updateTowerVisuals(tower) {
            if(tower.radiusElem) {
                tower.radiusElem.style.width = tower.radius*2 + 'px';
                tower.radiusElem.style.height = tower.radius*2 + 'px';
            }
        }

        function updateMoney() {
            document.getElementById('money').textContent = money;
        }

        function endGame() {
            gameActive = false;
            document.getElementById('gameOver').style.display = 'block';
        }

        function restartGame() {
            // Очищаем игровое поле
            board.innerHTML = '';
            enemies = [];
            towers = [];
            
            // Сбрасываем параметры
            money = 100;
            currentWave = 1;
            gameActive = true;
            
            // Обновляем интерфейс
            updateMoney();
            document.getElementById('wave').textContent = currentWave;
            document.getElementById('gameOver').style.display = 'none';
            closeUpgradeMenu();
            
            // Перезапускаем игру
            createBoard();
            startWave();
            gameLoop();
        }

        // Инициализация игры
        function initGame() {
            money = 100;
            currentWave = 1;
            enemies = [];
            towers = [];
            selectedTower = null;
            waveInProgress = false;
            gameActive = true;
            
            board.innerHTML = '';
            createBoard();
            
            updateMoney();
            document.getElementById('wave').textContent = currentWave;
            document.getElementById('gameOver').style.display = 'none';
            closeUpgradeMenu();
            
            gameLoop();
            startWave();
        }

        window.addEventListener('load', initGame);
        function placeTower(tower) {
    const elem = document.createElement('div');
    elem.className = `tower ${tower.type}`;
    elem.style.left = tower.x + 'px';
    elem.style.top = tower.y + 'px';
    
    let clickCount = 0;
    let clickTimer = null;
    
    elem.onclick = (e) => {
        e.stopPropagation();
        clickCount++;
        
        if (clickTimer === null) {
            clickTimer = setTimeout(() => {
                if (clickCount === 1) {
                    showUpgradeMenu(tower);
                } else if (clickCount === 3) {
                    removeTower(tower);
                }
                clickCount = 0;
                clickTimer = null;
            }, 300);
        }
    };
    
    const radius = document.createElement('div');
    radius.className = 'radius';
    radius.style.width = tower.radius*2 + 'px';
    radius.style.height = tower.radius*2 + 'px';
    radius.style.left = tower.x + 'px';
    radius.style.top = tower.y + 'px';
    
    board.appendChild(elem);
    board.appendChild(radius);
    tower.elem = elem;
    tower.radiusElem = radius;
}

function removeTower(tower) {
    if (!gameActive) return;
    
    // Возвращаем 50% стоимости башни
    const refund = Math.floor(towerTypes[tower.type].cost * 0.5);
    money += refund;
    updateMoney();
    
    // Удаляем элементы из DOM
    if (tower.elem) tower.elem.remove();
    if (tower.radiusElem) tower.radiusElem.remove();
    
    // Удаляем из массива башен
    towers = towers.filter(t => t !== tower);
    
    // Закрываем меню, если удаляем выбранную башню
    if (selectedTower === tower) {
        closeUpgradeMenu();
    }
}

// Исправленная функция startWave
function startWave() {
    if(!gameActive) return;
    
    waveInProgress = true;
    document.getElementById('wave').textContent = currentWave;
    
    if(currentWave === 1) {
        for(let i = 0; i < 3; i++) {
            setTimeout(() => spawnEnemy(2), i*2000);
        }
    } else if(currentWave === 2) {
        for(let i = 0; i < 5; i++) {
            setTimeout(() => spawnEnemy(2), i*2000);
        }
    } else if(currentWave === 3) {
        for(let i = 0; i < 10; i++) {
            setTimeout(() => spawnEnemy(2), i*1500);
        }
    } else if(currentWave === 4) {
        for(let i = 0; i < 15; i++) {
            setTimeout(() => spawnEnemy(2), i*1000);
        }
    } else if(currentWave === 5) {
        for(let i = 0; i < 5; i++) {
            setTimeout(() => spawnEnemy(2), i*1500);
        }
        setTimeout(() => spawnEnemy(5), 5*1500);
    }
}
          function startWave() {
            if(!gameActive) return;
            
            waveInProgress = true;
            document.getElementById('wave').textContent = currentWave;
            
            // Базовая логика волн
            if(currentWave === 1) {
                for(let i = 0; i < 3; i++) {
                    setTimeout(() => spawnEnemy(2), i*2000);
                }
            } else if(currentWave === 2) {
                for(let i = 0; i < 5; i++) {
                    setTimeout(() => spawnEnemy(2), i*2000);
                }
            } else if(currentWave === 3) {
                for(let i = 0; i < 10; i++) {
                    setTimeout(() => spawnEnemy(2), i*1500);
                }
            } 
            // Волны 5+ с фиолетовыми врагами
            else if(currentWave >= 5 && currentWave < 15) {
                const normalCount = 5 + (currentWave - 5) * 2;
                const strongCount = Math.floor(currentWave / 5);
                
                for(let i = 0; i < normalCount; i++) {
                    setTimeout(() => spawnEnemy(2), i*1500);
                }
                for(let i = 0; i < strongCount; i++) {
                    setTimeout(() => spawnEnemy(5, 'strong'), (normalCount + i)*2000);
                }
            }
            // Волны 15+ с золотыми врагами
            else if(currentWave >= 15 && currentWave < 30) {
                const normalCount = 10 + (currentWave - 15) * 3;
                const strongCount = 5 + Math.floor(currentWave / 3);
                const eliteCount = Math.floor(currentWave / 15);
                
                for(let i = 0; i < normalCount; i++) {
                    setTimeout(() => spawnEnemy(2), i*1000);
                }
                for(let i = 0; i < strongCount; i++) {
                    setTimeout(() => spawnEnemy(5, 'strong'), (normalCount + i)*1500);
                }
                for(let i = 0; i < eliteCount; i++) {
                    setTimeout(() => spawnEnemy(10, 'elite'), (normalCount + strongCount + i)*2000);
                }
            }
            // Волны 30+ с усиленными врагами
            else if(currentWave >= 30) {
                const normalCount = 20 + (currentWave - 30) * 5;
                const strongCount = 10 + Math.floor(currentWave / 2);
                const eliteCount = 10 + Math.floor(currentWave / 3);
                
                for(let i = 0; i < normalCount; i++) {
                    setTimeout(() => spawnEnemy(3), i*800);
                }
                for(let i = 0; i < strongCount; i++) {
                    setTimeout(() => spawnEnemy(8, 'strong'), (normalCount + i)*1000);
                }
                for(let i = 0; i < eliteCount; i++) {
                    setTimeout(() => spawnEnemy(15, 'elite'), (normalCount + strongCount + i)*1200);
                }
            }
            // Обычные волны (4, 6-14 и т.д.)
            else {
                const count = 10 + (currentWave - 1) * 3;
                for(let i = 0; i < count; i++) {
                    setTimeout(() => spawnEnemy(2 + Math.floor(currentWave/3)), i*1200);
                }
            }
        }

        function spawnEnemy(hp, type = 'normal') {
            const enemy = {
                x: 0,
                y: 4 * tileSize + 10,
                hp: hp,
                pathIndex: 0,
                type: type,
                speed: type === 'elite' ? 3 : type === 'strong' ? 1.5 : 1
            };
            
            const elem = document.createElement('div');
            elem.className = `enemy ${type}`;
            elem.style.left = enemy.x + 'px';
            elem.style.top = enemy.y + 'px';
            board.appendChild(elem);
            enemy.elem = elem;
            enemies.push(enemy);
        }

        function gameLoop() {
            if(!gameActive) return;
            
            enemies.forEach((enemy, index) => {
                const path = document.querySelectorAll('.tile');
                if(enemy.pathIndex >= path.length - 1) {
                    enemy.elem.remove();
                    enemies.splice(index, 1);
                    endGame();
                    return;
                }
                
                const target = path[enemy.pathIndex + 1];
                if(target) {
                    const targetX = parseInt(target.style.left) + tileSize/2;
                    const targetY = parseInt(target.style.top) + tileSize/2;
                    
                    const dx = targetX - enemy.x;
                    const dy = targetY - enemy.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    if(distance < 2) {
                        enemy.pathIndex++;
                    } else {
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }
                    
                    enemy.elem.style.left = enemy.x + 'px';
                    enemy.elem.style.top = enemy.y + 'px';
                }
            });
            
            attackLogic();
            requestAnimationFrame(gameLoop);
        }

        // ... (остальные функции без изменений) ...

        function initGame() {
            money = 100;
            currentWave = 1; // Теперь точно начинаем с 1 волны
            enemies = [];
            towers = [];
            selectedTower = null;
            waveInProgress = false;
            gameActive = true;
            
            board.innerHTML = '';
            createBoard();
            
            updateMoney();
            document.getElementById('wave').textContent = currentWave;
            document.getElementById('gameOver').style.display = 'none';
            closeUpgradeMenu();
            
            gameLoop();
            startWave();
        }
         let gameSpeed = 1;
        let bossHealthDisplay = null;

        const towerTypes = {
            // ... (предыдущие башни) ...
            mega: {
                type: 'mega',
                cost: 1500,
                modes: [
                    {damage: 2, radius: 50, attackSpeed: 2}, // Ближний бой
                    {damage: 1, radius: 200, attackSpeed: 1}  // Дальний бой
                ],
                currentMode: 0,
                upgraded: false
            }
        };

        // Новая функция для управления скоростью
        function setGameSpeed(speed) {
            gameSpeed = speed;
            document.getElementById('speed1x').classList.toggle('active', speed === 1);
            document.getElementById('speed2x').classList.toggle('active', speed === 2);
        }

        // Обновлённая функция spawnEnemy
        function spawnEnemy(hp, type = 'normal') {
            const speeds = {
                normal: 1,
                strong: 1.5,
                elite: 3,
                green: 0.5,
                boss: 0.33,
                black: 2
            };
            
            const enemy = {
                x: 0,
                y: 4 * tileSize + 10,
                hp: hp,
                maxHp: hp,
                pathIndex: 0,
                type: type,
                speed: speeds[type] || 1
            };
            
            const elem = document.createElement('div');
            elem.className = `enemy ${type}`;
            elem.style.left = enemy.x + 'px';
            elem.style.top = enemy.y + 'px';
            
            if (type === 'boss') {
                const healthElem = document.createElement('div');
                healthElem.className = 'boss-health';
                healthElem.textContent = `${enemy.hp}/${enemy.maxHp}`;
                elem.appendChild(healthElem);
                enemy.healthElem = healthElem;
            }
            
            board.appendChild(elem);
            enemy.elem = elem;
            enemies.push(enemy);
        }

        // Обновлённая функция gameLoop
        function gameLoop() {
            if(!gameActive) return;
            
            enemies.forEach((enemy, index) => {
                // ... (предыдущая логика движения) ...
                enemy.x += (dx / distance) * enemy.speed * gameSpeed;
                enemy.y += (dy / distance) * enemy.speed * gameSpeed;
                
                if (enemy.healthElem) {
                    enemy.healthElem.textContent = `${enemy.hp}/${enemy.maxHp}`;
                    enemy.healthElem.style.left = enemy.x + 'px';
                    enemy.healthElem.style.top = enemy.y + 'px';
                }
            });
            
            attackLogic();
            requestAnimationFrame(gameLoop);
        }

        // Обновлённая функция attackLogic для МЕГА башни
        function attackLogic() {
            towers.forEach(tower => {
                if (tower.type === 'mega') {
                    const mode = tower.modes[tower.currentMode];
                    if (Date.now() - tower.lastAttack > (1000/mode.attackSpeed)/gameSpeed) {
                        // Логика атаки для МЕГА башни
                        let target = findTarget(tower, mode.radius);
                        if (target) {
                            target.hp -= mode.damage;
                            tower.lastAttack = Date.now();
                            // ... (обработка убийства врага)
                        }
                    }
                } else {
                    // Обычная логика атаки
                }
            });
        }

        // Обновлённая функция startWave
        function startWave() {
            // ... (предыдущие волны) ...
            else if(currentWave >= 40 && currentWave < 50) {
                // ... + зелёные враги
                setTimeout(() => spawnEnemy(100, 'green'), (normalCount + strongCount + eliteCount)*1500);
            }
            else if(currentWave === 50) {
                // Босс
                setTimeout(() => spawnEnemy(1000, 'boss'), 2000);
            }
            else if(currentWave >= 65) {
                // ... + чёрные враги
                for(let i = 0; i < Math.floor(currentWave/6.5); i++) {
                    setTimeout(() => spawnEnemy(50, 'black'), (normalCount + strongCount + eliteCount + greenCount + i)*1000);
                }
            }
        }

        // Функция для переключения режима МЕГА башни
        function toggleMegaMode(tower) {
            if (tower.type === 'mega') {
                tower.currentMode = (tower.currentMode + 1) % tower.modes.length;
                updateTowerVisuals(tower);
                showUpgradeMenu(tower);
            }
        }

        // Обновлённая placeTower для МЕГА башни
        function placeTower(tower) {
            // ... (предыдущий код) ...
            if (tower.type === 'mega') {
                elem.onclick = (e) => {
                    e.stopPropagation();
                    clickCount++;
                    
                    if (clickTimer === null) {
                        clickTimer = setTimeout(() => {
                            if (clickCount === 1) {
                                showUpgradeMenu(tower);
                            } 
                            else if (clickCount === 2) {
                                toggleMegaMode(tower);
                            }
                            else if (clickCount === 3) {
                                removeTower(tower);
                            }
                            clickCount = 0;
                            clickTimer = null;
                        }, 300);
                    }
                };
            }
            // ... (остальной код)
        }


        window.addEventListener('load', initGame);
    </script>
</body>
</html>
</html>
