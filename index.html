<!DOCTYPE html>
<html>
<head>
    <title>Ultimate Tower Defense - Рабочая версия</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #gameContainer {
            display: flex;
            height: 100vh;
        }
        
        #gameBoard {
            width: 800px;
            height: 600px;
            border: 2px solid #333;
            position: relative;
            background: #e8f5e9;
            overflow: hidden;
        }
        
        .tile {
            width: 40px;
            height: 40px;
            position: absolute;
            box-sizing: border-box;
        }
        
        .path {
            background: #5d4037;
            border: 1px solid #3e2723;
        }
        
        .start {
            background: #ffd700;
            border: 2px solid #ffab00;
        }
        
        .end {
            background: #4caf50;
            border: 2px solid #2e7d32;
        }
        
        .enemy {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .enemy.normal {
            width: 20px;
            height: 20px;
            background: #f44336;
        }
        
        .enemy.strong {
            width: 25px;
            height: 25px;
            background: #9c27b0;
        }
        
        .enemy.elite {
            width: 30px;
            height: 30px;
            background: #ff9800;
            animation: pulse 1s infinite;
        }
        
        .enemy.green {
            width: 25px;
            height: 25px;
            background: #4caf50;
        }
        
        .enemy.boss {
            width: 40px;
            height: 40px;
            background: #f44336;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: bossPulse 2s infinite;
        }
        
        .enemy.black {
            width: 20px;
            height: 20px;
            background: #000000;
        }
        
        .tower {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
        }
        
        .tower.pistol {
            width: 30px;
            height: 30px;
            background: #2196f3;
            border-radius: 50%;
            border: 2px solid #0d47a1;
        }
        
        .tower.swordsman {
            width: 30px;
            height: 30px;
            background: #795548;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            border: 2px solid #3e2723;
        }
        
        .tower.sniper {
            width: 30px;
            height: 30px;
            background: #673ab7;
            border-radius: 5px;
            border: 2px solid #311b92;
        }
        
        .tower.mega {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ff0000, #ffff00);
            clip-path: polygon(20% 0%, 80% 0%, 100% 50%, 80% 100%, 20% 100%, 0% 50%);
            border: 2px solid #e65100;
        }
        
        .radius {
            position: absolute;
            border: 2px dashed rgba(33, 150, 243, 0.5);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            box-sizing: border-box;
            z-index: 5;
        }
        
        #shop {
            width: 250px;
            padding: 15px;
            background: #e0e0e0;
            overflow-y: auto;
            border-left: 2px solid #bdbdbd;
        }
        
        .shop-item {
            margin: 10px 0;
            padding: 12px;
            border: 2px solid #4caf50;
            border-radius: 8px;
            background: linear-gradient(145deg, #81c784, #66bb6a);
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        
        .shop-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        #upgradeMenu {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 200px;
            padding: 15px;
            background: #fff;
            border: 2px solid #ff9800;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 100;
        }
        
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
            z-index: 200;
        }
        
        .speed-control {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 50;
            background: rgba(255,255,255,0.7);
            padding: 5px;
            border-radius: 5px;
        }
        
        .speed-control button {
            padding: 5px 10px;
            margin: 0 3px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .speed-control button.active {
            background: #2e7d32;
            font-weight: bold;
        }
        
        .boss-health {
            position: absolute;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px black;
            transform: translate(-50%, -30px);
            white-space: nowrap;
            font-size: 12px;
            z-index: 15;
        }
        
        #moneyDisplay {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            color: #333;
        }
        
        #waveDisplay {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            color: #333;
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        @keyframes bossPulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="gameBoard"></div>
        <div id="shop">
            <div class="shop-item" onclick="selectTower('pistol', 50)">
                Пистолет (50)<br>
                Урон: 1/сек<br>
                Радиус: 10st
            </div>
            <div class="shop-item" onclick="selectTower('swordsman', 80)">
                Мечник (80)<br>
                Урон: 2/0.5сек<br>
                Радиус: 5st
            </div>
            <div class="shop-item" onclick="selectTower('sniper', 250)">
                Снайпер (250)<br>
                Урон: 10/5сек<br>
                Радиус: 100st
            </div>
            <div class="shop-item" onclick="selectTower('mega', 1500)">
                МЕГА (1500)<br>
                Двойной режим:<br>
                Ближний: 2/0.5сек 5st<br>
                Дальний: 1/сек 20st
            </div>
            <div id="moneyDisplay">Деньги: 100</div>
            <div id="waveDisplay">Волна: 1</div>
        </div>
    </div>
    
    <div class="speed-control">
        <button id="speed1x" class="active" onclick="setGameSpeed(1)">1X</button>
        <button id="speed2x" onclick="setGameSpeed(2)">2X</button>
    </div>
    
    <div id="upgradeMenu">
        <h4 style="margin-top: 0; color: #ff9800;">Улучшение башни</h4>
        <div id="towerStats" style="margin-bottom: 10px;"></div>
        <button onclick="upgradeTower()" style="background: #ff9800; width: 100%;">Улучшить</button>
        <button onclick="closeUpgradeMenu()" style="background: #9e9e9e; width: 100%; margin-top: 5px;">Закрыть</button>
    </div>
    
    <div id="gameOver">
        <h2 style="margin-top: 0;">Враги добрались до цели!</h2>
        <p>Дошло врагов: <span id="enemiesPassed">0</span></p>
        <p>Достигнутая волна: <span id="finalWave">1</span></p>
        <button onclick="restartGame()" style="background: #4caf50; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Играть снова</button>
    </div>

    <script>
        // Основные переменные
        const board = document.getElementById('gameBoard');
        const tileSize = 40;
        let placingTower = false;
        let money = 100;
        let currentWave = 1;
        let enemies = [];
        let towers = [];
        let selectedTower = null;
        let waveInProgress = false;
        let gameActive = true;
        let gameSpeed = 1;
        let enemiesPassed = 0;
        let endPosition = {x: 0, y: 0};
        let pathTiles = [];

        // Типы башен
        const towerTypes = {
            pistol: {
                type: 'pistol',
                cost: 50,
                damage: 1,
                radius: 100,
                attackSpeed: 1,
                upgraded: false,
                upgradeCost: 150,
                upgradedDamage: 2,
                upgradedRadius: 150
            },
            swordsman: {
                type: 'swordsman',
                cost: 80,
                damage: 2,
                radius: 50,
                attackSpeed: 2,
                upgraded: false,
                upgradeCost: 150,
                upgradedDamage: 3,
                upgradedAttackSpeed: 3
            },
            sniper: {
                type: 'sniper',
                cost: 250,
                damage: 10,
                radius: 1000,
                attackSpeed: 0.2,
                upgraded: false,
                upgradeCost: 1000,
                upgradedAttackSpeed: 0.4
            },
            mega: {
                type: 'mega',
                cost: 1500,
                modes: [
                    {damage: 2, radius: 50, attackSpeed: 2}, // Ближний бой
                    {damage: 1, radius: 200, attackSpeed: 1}  // Дальний бой
                ],
                currentMode: 0,
                upgraded: false,
                upgradeCost: 2000,
                upgradedModes: [
                    {damage: 3, radius: 60, attackSpeed: 2.5},
                    {damage: 2, radius: 250, attackSpeed: 1.2}
                ]
            }
        };

        // Создание игрового поля с дорожкой
        function createBoard() {
            // Очищаем доску
            board.innerHTML = '';
            pathTiles = [];
            
            // Создаем сложную дорожку с изгибами
            const path = [
                {x:0, y:4}, {x:1, y:4}, {x:2, y:4}, {x:3, y:4}, {x:4, y:4}, {x:5, y:4},
                {x:5, y:5}, {x:5, y:6}, {x:5, y:7}, {x:5, y:8}, {x:5, y:9},
                {x:6, y:9}, {x:7, y:9}, {x:8, y:9}, {x:9, y:9}, {x:10, y:9},
                {x:10, y:8}, {x:10, y:7}, {x:10, y:6}, {x:10, y:5},
                {x:11, y:5}, {x:12, y:5}, {x:13, y:5}, {x:14, y:5}, {x:15, y:5},
                {x:15, y:6}, {x:15, y:7}, {x:15, y:8}, {x:15, y:9}, {x:15, y:10},
                {x:16, y:10}, {x:17, y:10}, {x:18, y:10}, {x:19, y:10}, {x:20, y:10},
                {x:20, y:11}
            ];
            
            // Создаем тайлы дорожки
            path.forEach((pos, index) => {
                const tile = document.createElement('div');
                tile.className = `tile ${index === 0 ? 'start' : index === path.length-1 ? 'end' : 'path'}`;
                tile.style.left = pos.x * tileSize + 'px';
                tile.style.top = pos.y * tileSize + 'px';
                board.appendChild(tile);
                
                // Сохраняем позиции дорожки для проверки
                pathTiles.push({
                    x: pos.x * tileSize + tileSize/2,
                    y: pos.y * tileSize + tileSize/2,
                    elem: tile
                });
            });
            
            // Запоминаем позицию конечной точки
            endPosition = {
                x: path[path.length-1].x * tileSize + tileSize/2,
                y: path[path.length-1].y * tileSize + tileSize/2
            };
        }

        // Выбор башни для размещения
        function selectTower(type, cost) {
            if(!gameActive) return;
            if(money >= cost && !placingTower) {
                placingTower = type;
                money -= cost;
                updateMoney();
            }
        }

        // Обработчик кликов по игровому полю
        board.addEventListener('click', function(e) {
            if(!gameActive || !placingTower) return;
            
            const rect = board.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Проверяем, не кликнули ли на дорожку
            const isOnPath = pathTiles.some(tile => {
                return Math.abs(x - tile.x) < tileSize/2 && Math.abs(y - tile.y) < tileSize/2;
            });
            
            // Проверяем, не кликнули ли на другую башню
            const isOnTower = towers.some(tower => {
                return Math.sqrt(Math.pow(x - tower.x, 2) + Math.pow(y - tower.y, 2) < 30;
            });
            
            if(!isOnPath && !isOnTower) {
                const tower = {
                    ...towerTypes[placingTower],
                    x: x,
                    y: y,
                    totalDamage: 0,
                    lastAttack: 0
                };
                
                // Для МЕГА башни добавляем текущий режим
                if(tower.type === 'mega') {
                    tower.currentMode = 0;
                }
                
                towers.push(tower);
                placeTower(tower);
                placingTower = false;
            }
        });

        // Размещение башни на поле
        function placeTower(tower) {
            const elem = document.createElement('div');
            elem.className = `tower ${tower.type}`;
            elem.style.left = tower.x + 'px';
            elem.style.top = tower.y + 'px';
            
            let clickCount = 0;
            let clickTimer = null;
            
            elem.onclick = function(e) {
                e.stopPropagation();
                clickCount++;
                
                if (clickTimer === null) {
                    clickTimer = setTimeout(() => {
                        if (clickCount === 1) {
                            showUpgradeMenu(tower);
                        } 
                        else if (clickCount === 2 && tower.type === 'mega') {
                            toggleMegaMode(tower);
                        }
                        else if (clickCount === 3) {
                            removeTower(tower);
                        }
                        clickCount = 0;
                        clickTimer = null;
                    }, 300);
                }
            };
            
            const radius = document.createElement('div');
            radius.className = 'radius';
            
            if(tower.type === 'mega') {
                radius.style.width = tower.modes[tower.currentMode].radius * 2 + 'px';
                radius.style.height = tower.modes[tower.currentMode].radius * 2 + 'px';
            } else {
                radius.style.width = tower.radius * 2 + 'px';
                radius.style.height = tower.radius * 2 + 'px';
            }
            
            radius.style.left = tower.x + 'px';
            radius.style.top = tower.y + 'px';
            
            board.appendChild(elem);
            board.appendChild(radius);
            tower.elem = elem;
            tower.radiusElem = radius;
        }

        // Удаление башни
        function removeTower(tower) {
            if (!gameActive) return;
            
            // Возвращаем 50% стоимости башни
            const refund = Math.floor(towerTypes[tower.type].cost * 0.5);
            money += refund;
            updateMoney();
            
            // Удаляем элементы из DOM
            if (tower.elem) tower.elem.remove();
            if (tower.radiusElem) tower.radiusElem.remove();
            
            // Удаляем из массива башен
            towers = towers.filter(t => t !== tower);
            
            // Закрываем меню, если удаляем выбранную башню
            if (selectedTower === tower) {
                closeUpgradeMenu();
            }
        }

        // Создание врага
        function spawnEnemy(hp, type = 'normal') {
            const speeds = {
                normal: 1,
                strong: 1.5,
                elite: 3,
                green: 0.5,
                boss: 0.33,
                black: 2
            };
            
            const enemy = {
                x: pathTiles[0].x,
                y: pathTiles[0].y,
                hp: hp,
                maxHp: hp,
                pathIndex: 0,
                type: type,
                speed: speeds[type] || 1
            };
            
            const elem = document.createElement('div');
            elem.className = `enemy ${type}`;
            elem.style.left = enemy.x + 'px';
            elem.style.top = enemy.y + 'px';
            
            if (type === 'boss') {
                const healthElem = document.createElement('div');
                healthElem.className = 'boss-health';
                healthElem.textContent = `${enemy.hp}/${enemy.maxHp}`;
                elem.appendChild(healthElem);
                enemy.healthElem = healthElem;
            }
            
            board.appendChild(elem);
            enemy.elem = elem;
            enemies.push(enemy);
        }

        // Главный игровой цикл
        function gameLoop() {
            if(!gameActive) return;
            
            // Движение врагов
            enemies.forEach((enemy, index) => {
                // Проверка достижения конца пути
                if(enemy.pathIndex >= pathTiles.length - 1) {
                    enemy.elem.remove();
                    if(enemy.healthElem) enemy.healthElem.remove();
                    enemies.splice(index, 1);
                    enemiesPassed++;
                    document.getElementById('enemiesPassed').textContent = enemiesPassed;
                    endGame();
                    return;
                }
                
                const target = pathTiles[enemy.pathIndex + 1];
                const dx = target.x - enemy.x;
                const dy = target.y - enemy.y;
                const distance = Math.sqrt(dx*dx + dy*dy);
                
                if(distance < 2) {
                    enemy.pathIndex++;
                } else {
                    enemy.x += (dx / distance) * enemy.speed * gameSpeed;
                    enemy.y += (dy / distance) * enemy.speed * gameSpeed;
                }
                
                enemy.elem.style.left = enemy.x + 'px';
                enemy.elem.style.top = enemy.y + 'px';
                
                if (enemy.healthElem) {
                    enemy.healthElem.textContent = `${enemy.hp}/${enemy.maxHp}`;
                    enemy.healthElem.style.left = enemy.x + 'px';
                    enemy.healthElem.style.top = (enemy.y - 30) + 'px';
                }
            });
            
            // Логика атак башен
            attackLogic();
            
            // Продолжаем цикл
            requestAnimationFrame(gameLoop);
        }

        // Логика атак башен
        function attackLogic() {
            towers.forEach(tower => {
                // Для МЕГА башни
                if (tower.type === 'mega') {
                    const mode = tower.upgraded ? tower.upgradedModes[tower.currentMode] : tower.modes[tower.currentMode];
                    
                    if (Date.now() - tower.lastAttack > (1000/mode.attackSpeed)/gameSpeed) {
                        let closestEnemy = null;
                        let minDistance = Infinity;
                        
                        enemies.forEach(enemy => {
                            const dx = enemy.x - tower.x;
                            const dy = enemy.y - tower.y;
                            const distance = Math.sqrt(dx*dx + dy*dy);
                            
                            if (distance < mode.radius && distance < minDistance) {
                                closestEnemy = enemy;
                                minDistance = distance;
                            }
                        });
                        
                        if (closestEnemy) {
                            closestEnemy.hp -= mode.damage;
                            tower.totalDamage += mode.damage;
                            tower.lastAttack = Date.now();
                            
                            if (closestEnemy.hp <= 0) {
                                closestEnemy.elem.remove();
                                if(closestEnemy.healthElem) closestEnemy.healthElem.remove();
                                enemies.splice(enemies.indexOf(closestEnemy), 1);
                                money += getKillReward(closestEnemy.type);
                                updateMoney();
                            } else if (closestEnemy.healthElem) {
                                closestEnemy.healthElem.textContent = `${closestEnemy.hp}/${closestEnemy.maxHp}`;
                            }
                        }
                    }
                } 
                // Для обычных башен
                else {
                    const attackSpeed = tower.upgraded ? 
                        (tower.type === 'sniper' ? tower.upgradedAttackSpeed : 
                         tower.type === 'swordsman' ? tower.upgradedAttackSpeed : 
                         tower.attackSpeed) : tower.attackSpeed;
                    
                    if (Date.now() - tower.lastAttack > (1000/attackSpeed)/gameSpeed) {
                        let closestEnemy = null;
                        let minDistance = Infinity;
                        
                        enemies.forEach(enemy => {
                            const dx = enemy.x - tower.x;
                            const dy = enemy.y - tower.y;
                            const distance = Math.sqrt(dx*dx + dy*dy);
                            const radius = tower.upgraded && tower.type === 'pistol' ? tower.upgradedRadius : tower.radius;
                            
                            if (distance < radius && distance < minDistance) {
                                closestEnemy = enemy;
                                minDistance = distance;
                            }
                        });
                        
                        if (closestEnemy) {
                            const damage = tower.upgraded ? 
                                (tower.type === 'pistol' ? tower.upgradedDamage : 
                                 tower.type === 'swordsman' ? tower.upgradedDamage : 
                                 tower.damage) : tower.damage;
                            
                            closestEnemy.hp -= damage;
                            tower.totalDamage += damage;
                            tower.lastAttack = Date.now();
                            
                            if (closestEnemy.hp <= 0) {
                                closestEnemy.elem.remove();
                                if(closestEnemy.healthElem) closestEnemy.healthElem.remove();
                                enemies.splice(enemies.indexOf(closestEnemy), 1);
                                money += getKillReward(closestEnemy.type);
                                updateMoney();
                            } else if (closestEnemy.healthElem) {
                                closestEnemy.healthElem.textContent = `${closestEnemy.hp}/${closestEnemy.maxHp}`;
                            }
                        }
                    }
                }
            });
            
            // Проверка завершения волны
            checkWaveCompletion();
        }

        // Получить награду за убийство врага
        function getKillReward(type) {
            switch(type) {
                case 'boss': return 200;
                case 'elite': return 50;
                case 'strong': return 20;
                case 'green': return 30;
                case 'black': return 40;
                default: return 10;
            }
        }

        // Проверка завершения волны
        function checkWaveCompletion() {
            if(enemies.length === 0 && waveInProgress) {
                waveInProgress = false;
                currentWave++;
                updateWaveDisplay();
                startWave();
            }
        }

        // Запуск волны врагов
        function startWave() {
            if(!gameActive) return;
            
            waveInProgress = true;
            
            // Волна 1: 3 обычных врага
            if(currentWave === 1) {
                for(let i = 0; i < 3; i++) {
                    setTimeout(() => spawnEnemy(2), i*2000/gameSpeed);
                }
            } 
            // Волна 2: 5 обычных врагов
            else if(currentWave === 2) {
                for(let i = 0; i < 5; i++) {
                    setTimeout(() => spawnEnemy(2), i*2000/gameSpeed);
                }
            }
            // Волна 3: 10 обычных врагов
            else if(currentWave === 3) {
                for(let i = 0; i < 10; i++) {
                    setTimeout(() => spawnEnemy(2), i*1500/gameSpeed);
                }
            }
            // Волна 4: 15 обычных врагов
            else if(currentWave === 4) {
                for(let i = 0; i < 15; i++) {
                    setTimeout(() => spawnEnemy(2), i*1000/gameSpeed);
                }
            }
            // Волна 5: 5 обычных + 1 фиолетовый
            else if(currentWave === 5) {
                for(let i = 0; i < 5; i++) {
                    setTimeout(() => spawnEnemy(2), i*1500/gameSpeed);
                }
                setTimeout(() => spawnEnemy(5, 'strong'), 5*1500/gameSpeed);
            }
            // Волны 6-14
            else if(currentWave >= 6 && currentWave < 15) {
                const normalCount = 5 + (currentWave - 5) * 2;
                const strongCount = Math.floor(currentWave / 5);
                
                for(let i = 0; i < normalCount; i++) {
                    setTimeout(() => spawnEnemy(2 + Math.floor(currentWave/3)), i*1200/gameSpeed);
                }
                for(let i = 0; i < strongCount; i++) {
                    setTimeout(() => spawnEnemy(5 + Math.floor(currentWave/2), 'strong'), (normalCount + i)*1500/gameSpeed);
                }
            }
            // Волны 15-39
            else if(currentWave >= 15 && currentWave < 40) {
                const normalCount = 10 + (currentWave - 15) * 3;
                const strongCount = 5 + Math.floor(currentWave / 3);
                const eliteCount = Math.floor(currentWave / 15);
                
                for(let i = 0; i < normalCount; i++) {
                    setTimeout(() => spawnEnemy(2 + Math.floor(currentWave/2)), i*800/gameSpeed);
                }
                for(let i = 0; i < strongCount; i++) {
                    setTimeout(() => spawnEnemy(5 + currentWave, 'strong'), (normalCount + i)*1000/gameSpeed);
                }
                for(let i = 0; i < eliteCount; i++) {
                    setTimeout(() => spawnEnemy(10 + currentWave*2, 'elite'), (normalCount + strongCount + i)*1200/gameSpeed);
                }
            }
            // Волны 40-49
            else if(currentWave >= 40 && currentWave < 50) {
                const normalCount = 15 + (currentWave - 40) * 4;
                const strongCount = 10 + Math.floor(currentWave / 4);
                const eliteCount = 3 + Math.floor(currentWave / 10);
                const greenCount = Math.floor(currentWave / 40);
                
                for(let i = 0; i < normalCount; i++) {
                    setTimeout(() => spawnEnemy(3 + Math.floor(currentWave/2)), i*700/gameSpeed);
                }
                for(let i = 0; i < strongCount; i++) {
                    setTimeout(() => spawnEnemy(8 + currentWave, 'strong'), (normalCount + i)*800/gameSpeed);
                }
                for(let i = 0; i < eliteCount; i++) {
                    setTimeout(() => spawnEnemy(15 + currentWave*2, 'elite'), (normalCount + strongCount + i)*900/gameSpeed);
                }
                for(let i = 0; i < greenCount; i++) {
                    setTimeout(() => spawnEnemy(100, 'green'), (normalCount + strongCount + eliteCount + i)*1500/gameSpeed);
                }
            }
            // Волна 50: Босс
            else if(currentWave === 50) {
                setTimeout(() => spawnEnemy(1000, 'boss'), 2000/gameSpeed);
            }
            // Волны 51-64
            else if(currentWave > 50 && currentWave < 65) {
                const normalCount = 20 + (currentWave - 50) * 5;
                const strongCount = 15 + Math.floor(currentWave / 5);
                const eliteCount = 5 + Math.floor(currentWave / 8);
                const greenCount = Math.floor(currentWave / 50);
                
                for(let i = 0; i < normalCount; i++) {
                    setTimeout(() => spawnEnemy(5 + Math.floor(currentWave/2)), i*600/gameSpeed);
                }
                for(let i = 0; i < strongCount; i++) {
                    setTimeout(() => spawnEnemy(10 + currentWave, 'strong'), (normalCount + i)*700/gameSpeed);
                }
                for(let i = 0; i < eliteCount; i++) {
                    setTimeout(() => spawnEnemy(20 + currentWave*2, 'elite'), (normalCount + strongCount + i)*800/gameSpeed);
                }
                for(let i = 0; i < greenCount; i++) {
                    setTimeout(() => spawnEnemy(100, 'green'), (normalCount + strongCount + eliteCount + i)*1200/gameSpeed);
                }
            }
            // Волны 65+
            else {
                const normalCount = 25 + (currentWave - 65) * 6;
                const strongCount = 20 + Math.floor(currentWave / 5);
                const eliteCount = 10 + Math.floor(currentWave / 7);
                const greenCount = 5 + Math.floor(currentWave / 13);
                const blackCount = Math.floor(currentWave / 6.5);
                
                for(let i = 0; i < normalCount; i++) {
                    setTimeout(() => spawnEnemy(8 + Math.floor(currentWave/2)), i*500/gameSpeed);
                }
                for(let i = 0; i < strongCount; i++) {
                    setTimeout(() => spawnEnemy(15 + currentWave, 'strong'), (normalCount + i)*600/gameSpeed);
                }
                for(let i = 0; i < eliteCount; i++) {
                    setTimeout(() => spawnEnemy(30 + currentWave*2, 'elite'), (normalCount + strongCount + i)*700/gameSpeed);
                }
                for(let i = 0; i < greenCount; i++) {
                    setTimeout(() => spawnEnemy(100, 'green'), (normalCount + strongCount + eliteCount + i)*1000/gameSpeed);
                }
                for(let i = 0; i < blackCount; i++) {
                    setTimeout(() => spawnEnemy(50, 'black'), (normalCount + strongCount + eliteCount + greenCount + i)*800/gameSpeed);
                }
            }
        }

        // Показать меню улучшения
        function showUpgradeMenu(tower) {
            if(!gameActive) return;
            
            closeUpgradeMenu();
            selectedTower = tower;
            const menu = document.getElementById('upgradeMenu');
            menu.style.display = 'block';
            
            let upgradeButton = menu.querySelector('button');
            upgradeButton.textContent = tower.upgraded ? 'Улучшено' : `Улучшить (${tower.upgradeCost})`;
            upgradeButton.disabled = tower.upgraded || money < tower.upgradeCost;
            
            let statsText = '';
            if (tower.type === 'mega') {
                const mode = tower.upgraded ? tower.upgradedModes[tower.currentMode] : tower.modes[tower.currentMode];
                statsText = `
                    <strong>МЕГА (${tower.currentMode === 0 ? 'Ближний' : 'Дальний'})</strong><br>
                    Урон: ${mode.damage}<br>
                    Радиус: ${Math.round(mode.radius/10)}st<br>
                    Скорость: ${(1/mode.attackSpeed).toFixed(1)} атак/сек<br>
                    ${tower.upgraded ? '<span style="color:green">УЛУЧШЕНО</span>' : ''}
                `;
            } else {
                statsText = `
                    <strong>${getTowerName(tower.type)}</strong><br>
                    Урон: ${tower.upgraded ? tower.upgradedDamage || tower.damage : tower.damage}<br>
                    Радиус: ${Math.round((tower.upgraded && tower.type === 'pistol' ? tower.upgradedRadius : tower.radius)/10)}st<br>
                    Скорость: ${(1/(tower.upgraded && tower.type === 'sniper' ? tower.upgradedAttackSpeed : 
                                   tower.upgraded && tower.type === 'swordsman' ? tower.upgradedAttackSpeed : 
                                   tower.attackSpeed)).toFixed(1)} атак/сек<br>
                    ${tower.upgraded ? '<span style="color:green">УЛУЧШЕНО</span>' : ''}
                `;
            }
            
            document.getElementById('towerStats').innerHTML = statsText;
        }

        // Получить название башни
        function getTowerName(type) {
            switch(type) {
                case 'pistol': return 'Пистолет';
                case 'swordsman': return 'Мечник';
                case 'sniper': return 'Снайпер';
                case 'mega': return 'МЕГА';
                default: return 'Башня';
            }
        }

        // Закрыть меню улучшения
        function closeUpgradeMenu() {
            document.getElementById('upgradeMenu').style.display = 'none';
            selectedTower = null;
        }

        // Улучшить башню
        function upgradeTower() {
            if(!selectedTower || !gameActive || selectedTower.upgraded) return;
            if(money < selectedTower.upgradeCost) return;
            
            money -= selectedTower.upgradeCost;
            updateMoney();
            selectedTower.upgraded = true;
            
            if (selectedTower.type === 'mega') {
                // Для МЕГА башни улучшаем оба режима
                selectedTower.modes = [...selectedTower.upgradedModes];
            }
            
            updateTowerVisuals(selectedTower);
            showUpgradeMenu(selectedTower);
        }

        // Переключить режим МЕГА башни
        function toggleMegaMode(tower) {
            if (tower.type === 'mega') {
                tower.currentMode = (tower.currentMode + 1) % tower.modes.length;
                updateTowerVisuals(tower);
                showUpgradeMenu(tower);
            }
        }

        // Обновить визуал башни
        function updateTowerVisuals(tower) {
            if (tower.radiusElem) {
                if (tower.type === 'mega') {
                    const mode = tower.upgraded ? tower.upgradedModes[tower.currentMode] : tower.modes[tower.currentMode];
                    tower.radiusElem.style.width = mode.radius*2 + 'px';
                    tower.radiusElem.style.height = mode.radius*2 + 'px';
                } else if (tower.type === 'pistol' && tower.upgraded) {
                    tower.radiusElem.style.width = tower.upgradedRadius*2 + 'px';
                    tower.radiusElem.style.height = tower.upgradedRadius*2 + 'px';
                }
            }
        }

        // Установить скорость игры
        function setGameSpeed(speed) {
            gameSpeed = speed;
            document.getElementById('speed1x').classList.toggle('active', speed === 1);
            document.getElementById('speed2x').classList.toggle('active', speed === 2);
        }

        // Обновить отображение денег
        function updateMoney() {
            document.getElementById('moneyDisplay').textContent = `Деньги: ${money}`;
        }

        // Обновить отображение волны
        function updateWaveDisplay() {
            document.getElementById('waveDisplay').textContent = `Волна: ${currentWave}`;
        }

        // Завершение игры
        function endGame() {
            gameActive = false;
            document.getElementById('finalWave').textContent = currentWave;
            document.getElementById('gameOver').style.display = 'block';
        }

        // Перезапуск игры
        function restartGame() {
            // Очищаем игровое поле
            board.innerHTML = '';
            enemies = [];
            towers = [];
            
            // Сбрасываем параметры
            money = 100;
            currentWave = 1;
            enemiesPassed = 0;
            gameActive = true;
            
            // Обновляем интерфейс
            updateMoney();
            updateWaveDisplay();
            document.getElementById('enemiesPassed').textContent = '0';
            document.getElementById('gameOver').style.display = 'none';
            closeUpgradeMenu();
            
            // Перезапускаем игру
            createBoard();
            startWave();
            gameLoop();
        }

        // Инициализация игры
        function initGame() {
            money = 100;
            currentWave = 1;
            enemiesPassed = 0;
            enemies = [];
            towers = [];
            selectedTower = null;
            waveInProgress = false;
            gameActive = true;
            gameSpeed = 1;
            
            createBoard();
            updateMoney();
            updateWaveDisplay();
            document.getElementById('enemiesPassed').textContent = '0';
            document.getElementById('gameOver').style.display = 'none';
            closeUpgradeMenu();
            
            // Установим активную кнопку скорости
            document.getElementById('speed1x').classList.add('active');
            document.getElementById('speed2x').classList.remove('active');
            
            // Запускаем игровой цикл
            gameLoop();
            startWave();
        }

        // Запускаем игру при загрузке страницы
        window.onload = initGame;
    </script>
</body>
</html>
