<!DOCTYPE html>
<html>
<head>
    <title>BlockLang IDE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/codemirror.min.css">
    <style>
        body { margin: 0; padding: 20px; font-family: Arial; }
        #editor { border: 2px solid #ccc; height: 300px; margin-bottom: 10px; }
        #runBtn { padding: 10px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        #output { border: 1px solid #ccc; padding: 10px; min-height: 300px; position: relative; }
        .block { width: 50px; height: 50px; background: #2196F3; position: absolute; transition: all 0.5s ease; }
        .block.size2 { width: 100px; height: 100px; }
        .one-block { width: 50px; height: 50px; background: red; position: absolute; }
    </style>
</head>
<body>
    <div id="editor"></div>
    <button id="runBtn">▶ Запустить</button>
    <div id="output">
        <div id="blocks"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/clike/clike.min.js"></script>
    <script>
        const editor = CodeMirror(document.getElementById('editor'), {
            mode: 'text/x-csrc',
            lineNumbers: true,
            value: `add - block
function.block:Start()
block.size = in 1:
block.controller.function - sizes (E)
if block.use (E)
do block.size = 2
end - конец функций
block.move.out(20,20)
add - one.block
one.block.color(255, 0, 0)
one.block.position(100,100)
end)`
        });

        class Block {
            constructor() {
                this.element = document.createElement('div');
                this.element.className = 'block';
                this.x = 0;
                this.y = 0;
                this.size = 1;
                this.functions = {};
                document.getElementById('blocks').appendChild(this.element);
            }

            async moveOut(dx, dy, duration = 0.5) {
                this.x += dx;
                this.y += dy;
                this.element.style.transform = `translate(${this.x}px, ${this.y}px)`;
                return new Promise(resolve => setTimeout(resolve, duration * 1000));
            }

            setSize(size) {
                this.size = size;
                if (size === 2) {
                    this.element.classList.add('size2');
                } else {
                    this.element.classList.remove('size2');
                }
            }
        }

        class OneBlock {
            constructor() {
                this.element = document.createElement('div');
                this.element.className = 'one-block';
                this.x = 0;
                this.y = 0;
                document.getElementById('blocks').appendChild(this.element);
            }

            setPosition(x, y) {
                this.x = x;
                this.y = y;
                this.element.style.transform = `translate(${x}px, ${y}px)`;
            }
        }

        class Interpreter {
            constructor() {
                this.blocks = [];
                this.oneBlocks = [];
                this.currentBlock = null;
                this.keyHandlers = {};
            }

            init() {
                document.addEventListener('keydown', (e) => {
                    if (this.keyHandlers[e.key.toUpperCase()]) {
                        this.keyHandlers[e.key.toUpperCase()]();
                    }
                });
            }

            async execute(code) {
                document.getElementById('blocks').innerHTML = '';
                const lines = code.split('\n').filter(l => l.trim() !== '');
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('add - block')) {
                        this.currentBlock = new Block();
                        this.blocks.push(this.currentBlock);
                    }
                    else if (line.startsWith('function.block:Start()')) {
                        // Начало функции
                    }
                    else if (line.startsWith('block.size = in ')) {
                        const size = parseInt(line.split('block.size = in ')[1].replace(':', ''));
                        this.currentBlock.setSize(size);
                    }
                    else if (line.startsWith('block.controller.function - sizes (')) {
                        const key = line.match(/\((\w)\)/)[1].toUpperCase();
                        this.keyHandlers[key] = () => {
                            this.currentBlock.setSize(2);
                        };
                    }
                    else if (line.startsWith('block.move.out(')) {
                        const coords = line.match(/\((-?\d+),\s*(-?\d+)\)/);
                        await this.currentBlock.moveOut(parseInt(coords[1]), parseInt(coords[2]));
                    }
                    else if (line.startsWith('add - one.block')) {
                        this.currentOneBlock = new OneBlock();
                        this.oneBlocks.push(this.currentOneBlock);
                    }
                    else if (line.startsWith('one.block.position(')) {
                        const coords = line.match(/\((-?\d+),\s*(-?\d+)\)/);
                        this.currentOneBlock.setPosition(parseInt(coords[1]), parseInt(coords[2]));
                    }
                    else if (line === 'end)') {
                        break;
                    }
                }
            }
        }

        const interpreter = new Interpreter();
        interpreter.init();
        document.getElementById('runBtn').addEventListener('click', () => {
            interpreter.execute(editor.getValue());
        });
    </script>
</body>
</html>
